<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Rumors from Google Sheet (Public)</title>
    <style>
        .rumor-box {
            position: absolute;
            width: 200px;
            max-height: 240px;
            font-size: 18px;
            color: black;
            padding: 10px;
            border: 1px solid gray;
            background-color: lightyellow;
            word-wrap: break-word;
            display: none; /* Hidden by default, only shown when rumor is placed */
        }
        
        .rumor {
            display: inline-block;
            margin: 1em 0;
        }

        .empty {
            background-color: lightgrey;
        }
    </style>
</head>
<body>
    <h1 id='date-container'>Random Rumors [TODAY]</h1>
    <div id="container"></div>

    <script>
        const SHEET_ID = '1US_0N-OuejJP6cKoLXpVEKyD_9rD_JJF6FIL9uLuOV0';  // Replace with your actual Sheet ID
        const SHEET_NAME = 'Sheet1';  // Replace with your actual sheet name (or omit if default)
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        let seed = 0;

        const predeterminedPositions = [
{top: 	100	, left: 	50	}, {top: 	100	, left: 	300	}, {top: 	100	, left: 	550	}, {top: 	100	, left: 	800	}, {top: 	100	, left: 	1050	}, 
{top: 	330	, left: 	50	}, {top: 	330	, left: 	300	}, {top: 	330	, left: 	550	}, {top: 	330	, left: 	800	}, {top: 	330	, left: 	1050	}, 
{top: 	560	, left: 	50	}, {top: 	560	, left: 	300	}, {top: 	560	, left: 	550	}, {top: 	560	, left: 	800	}, {top: 	560	, left: 	1050	}, 

        ];

        // Utility function: Seed-based random generator (based on the date)
        function seededRandom() {
            var x = Math.sin(seed) * 10000;
            seed++;
            return x - Math.floor(x);
        }

        function getCurrentDate() {
           const date = new Date();
           return date.toDateString();
        }

        // Get the current date as a seed
        function getSeedFromDate() {
            const today = new Date();
            return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
        }

        // Fetch CSV data from the public Google Sheet
        async function fetchCSVData() {
            const response = await fetch(SHEET_URL);
            const csvText = await response.text();
            const data = csvText.split('\n').map(row => row.trim()).filter(row => row.length > 0);
            // remove header row, slice off the first/last quote marks, then split by "," (3 chars)
            const rumors = data.slice(1).map((s) => s.slice(1,-1).split('","'));
            const good_rumors = rumors.filter((r) => r[4] != "Completed" && r[4] != "Retired");
            return good_rumors;
        }
  
        function shuffle(array) {
            let currentIndex = array.length;

            // While there remain elements to shuffle...
            while (currentIndex != 0) {
              // Pick a remaining element...
              let randomIndex = Math.floor(seededRandom() * currentIndex);
              currentIndex--;

              // And swap it with the current element.
              [array[currentIndex], array[randomIndex]] = [
                  array[randomIndex], array[currentIndex]];
            }
        }

        function postRumor(rumor, pos, empty=false) {
            const container = document.getElementById('container');
            // Create a new div element for each rumor
            const div = document.createElement('div');
            div.className = 'rumor-box';
            if(empty) {
                rumor[2] = "[The rumor is in a language you don't understand]";
                div.className = 'rumor-box empty';
            }

            const author = rumor[1].length > 0 ? rumor[1] : "Anonymous";
            const trustworthy = rumor[3].length > 0 ? `<span class="trustworthy">Note: ${rumor[3]}</span>` : "";
            div.innerHTML = `<span class="author">${author}:</span><span class="rumor">${rumor[2]}</span>${trustworthy}`;

            // Apply the selected position to the rumor box
            div.style.top = pos.top + 'px';
            div.style.left = pos.left + 'px';

            // Show the rumor box
            div.style.display = 'block';

            // Append to the container
            container.appendChild(div);
        }

        // Randomly select and place rumors into predetermined positions
        function placeRandomRumors(rumors) {
            const container = document.getElementById('container');
            container.innerHTML = ''; // Clear previous content

            const numRumors = Math.floor(seededRandom() * (15 - 5 + 1)) + 5;  // Select between 5 and 15
            
            shuffle(rumors);
            shuffle(predeterminedPositions);
            
            const important_rumors = rumors.filter((r) => r[4] == "Important");
            const normal_rumors = rumors.filter((r) => r[4] == "Normal");
            
            const selectedPositions = [];

            for (let i = 0; i < important_rumors.length; i++) {
                // Select a random position for each rumor
                const pos = predeterminedPositions[i];
                postRumor(important_rumors[i], pos);
            }

            for (let i = important_rumors.length; i < numRumors; i++) {
                // Select a random position for each rumor
                const pos = predeterminedPositions[i];
                postRumor(normal_rumors[i], pos);
            }

            for (let i = numRumors; i < predeterminedPositions.length; i++) {
                const pos = predeterminedPositions[i];
                postRumor(["", "", "&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;", "", ""], pos, true);
            }
        }

        // Main function to fetch data and place rumors
        async function main() {
            const dateDisplay = document.getElementById("date-container");
            dateDisplay.innerHTML = `Rumors on ${getCurrentDate()}`;

            seed = getSeedFromDate();
            try {
                const strings = await fetchCSVData();
                placeRandomRumors(strings);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Run the main function when the page loads
        window.onload = main;
    </script>
</body>
</html>
